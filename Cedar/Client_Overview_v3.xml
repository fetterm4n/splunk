<form theme="dark">
  <label>Clients Overview - V3</label>
  <fieldset submitButton="true" autoRun="true">
    <input type="dropdown" token="client_id">
      <label>Client ID:</label>
      <choice value="*">All</choice>
      <initialValue>*</initialValue>
      <fieldForLabel>ovpn ID</fieldForLabel>
      <fieldForValue>ovpn_id</fieldForValue>
      <search>
        <query>host=core | rex "\s"ovpn-client-"(?&lt;ovpn_id&gt;[A-Z]{1,6})"  | top limit=50 ovpn_id</query>
        <earliest>0</earliest>
        <latest></latest>
      </search>
    </input>
    <input type="time" token="field1">
      <label>Time Range:</label>
      <default>
        <earliest>0</earliest>
        <latest></latest>
      </default>
    </input>
  </fieldset>
  <row>
    <panel>
      <single>
        <search base="file_transfer_base">
          <query>| stats count</query>
        </search>
        <option name="colorMode">block</option>
        <option name="drilldown">none</option>
        <option name="rangeColors">["0x53a051","0x0877a6","0xf8be34","0xf1813f","0xdc4e41"]</option>
        <option name="underLabel">File Transfer Alerts</option>
        <option name="useColors">0</option>
      </single>
    </panel>
    <panel>
      <single>
        <search base="http_alert_base">
          <query>| stats count</query>
        </search>
        <option name="drilldown">none</option>
        <option name="rangeColors">["0x53a051","0x0877a6","0xf8be34","0xf1813f","0xdc4e41"]</option>
        <option name="underLabel">HTTP Session Alerts</option>
      </single>
    </panel>
    <panel>
      <single>
        <search base="domain_alerts">
          <query>| stats count</query>
        </search>
        <option name="drilldown">none</option>
        <option name="rangeColors">["0x53a051","0x0877a6","0xf8be34","0xf1813f","0xdc4e41"]</option>
        <option name="underLabel">Domain Alerts</option>
      </single>
    </panel>
    <panel>
      <single>
        <search base="ip_alerts">
          <query>| stats count</query>
        </search>
        <option name="drilldown">none</option>
        <option name="rangeColors">["0x53a051","0x0877a6","0xf8be34","0xf1813f","0xdc4e41"]</option>
        <option name="underLabel">IP Alerts</option>
      </single>
    </panel>
  </row>
  <row>
    <panel>
      <table>
        <search>
          <query>host=core
| rex field=message "\s"ovpn-client-"(?&lt;ovpn_id&gt;[A-Z]{1,6})"
| rex field=message "/(?&lt;ovpn_ip_address&gt;\d+\.\d+\.\d+\.\d+)"
| search ovpn_id=$client_id$
| stats earliest(_time) as "First Active", latest(_time) as "Last Active" count by ovpn_id, ovpn_ip_address
| stats list(ovpn_ip_address) list("First Active") list("Last Active") list(count) by ovpn_id
| rename "list(First Active)" AS "First Active", "list(Last Active)" AS "Last Active", list(ovpn_ip_address) AS "OVPN IP Address", list(count) AS "Event Count"
| fieldformat "First Active"=strftime('First Active', "%c")
| fieldformat "Last Active"=strftime('Last Active', "%c")</query>
          <earliest>0</earliest>
          <latest></latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">20</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="percentagesRow">false</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
        <format type="color" field="ovpn_id">
          <colorPalette type="sharedList"></colorPalette>
          <scale type="sharedCategory"></scale>
        </format>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <chart>
        <search>
          <query>host="core"
| rex "\s"ovpn-client-"(?&lt;ovpn_id&gt;[A-Z]{1,6})"
| rex field=message "/(?&lt;ovpn_ip_address&gt;\d+\.\d+\.\d+\.\d+)"
| search ovpn_id=$client_id$
| timechart count usenull=false by ovpn_ip_address</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
        </search>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">-45</option>
        <option name="charting.axisTitleX.text">Client Activity by Date</option>
        <option name="charting.axisTitleY.visibility">collapsed</option>
        <option name="charting.axisY.abbreviation">none</option>
        <option name="charting.axisY.minimumNumber">0</option>
        <option name="charting.axisY.scale">log</option>
        <option name="charting.chart">column</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.showDataLabels">none</option>
        <option name="charting.chart.stackMode">default</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="refresh.display">progressbar</option>
      </chart>
      <html>
        <h1>
          <b>
            <font color="Yellow">  Client ID = $client_id$</font>
          </b>
        </h1>
      </html>
    </panel>
  </row>
  <row>
    <panel>
      <title>IP Location for Clients</title>
      <map>
        <search>
          <query>host=core
| rex "\s"ovpn-client-"(?&lt;ovpn_id&gt;[A-Z]{1,6})"
| search ovpn_id="$client_id$"
| rex field=message "/(?&lt;ovpn_ip_address&gt;\d+\.\d+\.\d+\.\d+)"
| iplocation ovpn_ip_address
| geostats count by ovpn_ip_address</query>
          <earliest>0</earliest>
          <latest></latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="drilldown">none</option>
        <option name="height">400</option>
        <option name="mapping.choroplethLayer.colorBins">5</option>
        <option name="mapping.choroplethLayer.colorMode">auto</option>
        <option name="mapping.choroplethLayer.maximumColor">0xaf575a</option>
        <option name="mapping.choroplethLayer.minimumColor">0x62b3b2</option>
        <option name="mapping.choroplethLayer.neutralPoint">0</option>
        <option name="mapping.choroplethLayer.shapeOpacity">0.75</option>
        <option name="mapping.choroplethLayer.showBorder">1</option>
        <option name="mapping.data.maxClusters">10</option>
        <option name="mapping.legend.placement">bottomright</option>
        <option name="mapping.map.center">(0,0)</option>
        <option name="mapping.map.panning">1</option>
        <option name="mapping.map.scrollZoom">0</option>
        <option name="mapping.map.zoom">2</option>
        <option name="mapping.markerLayer.markerMaxSize">50</option>
        <option name="mapping.markerLayer.markerMinSize">1</option>
        <option name="mapping.markerLayer.markerOpacity">0.8</option>
        <option name="mapping.showTiles">1</option>
        <option name="mapping.tileLayer.maxZoom">7</option>
        <option name="mapping.tileLayer.minZoom">0</option>
        <option name="mapping.tileLayer.tileOpacity">1</option>
        <option name="mapping.type">marker</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
      </map>
    </panel>
    <panel>
      <table>
        <search>
          <query>host=core
| eval Timeframe=strftime(_time, "%m-%d-%Y")
| rex "\s"ovpn-client-"(?&lt;ovpn_id&gt;[A-Z]{1,6})"
| search ovpn_id=$client_id$
| rex field=message "/(?&lt;ovpn_ip_address&gt;\d+\.\d+\.\d+\.\d+)"
| iplocation ovpn_ip_address
| stats values(ovpn_id) AS "Client ID" values(Timeframe) as "Timeframe" values(City) as "City", values(Country) as "Country" count AS "Event Count" by ovpn_ip_address
| sort -count</query>
          <earliest>0</earliest>
          <latest></latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">20</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="percentagesRow">false</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
        <format type="color" field="ovpn_ip_address">
          <colorPalette type="sharedList"></colorPalette>
          <scale type="sharedCategory"></scale>
        </format>
        <format type="color" field="count">
          <colorPalette type="minMidMax" maxColor="#006D9C" minColor="#FFFFFF"></colorPalette>
          <scale type="minMidMax"></scale>
        </format>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <title>Login Activity (syslog)</title>
      <table>
        <title>Click flow_id for Drilldown</title>
        <search>
          <query>host=core
| rex "\s"ovpn-client-"(?&lt;ovpn_id&gt;[A-Z]{1,6})"
| search ovpn_id=$client_id$
| rex field=message "/(?&lt;ovpn_ip_address&gt;\d+\.\d+\.\d+\.\d+)"
| rex field=message :"(?&lt;ovpn_ip_port&gt;[0-9]{1,6})"
| bucket _time span=1h
| convert ctime(_time) as Datestamp
| stats values(ovpn_ip_port) values(flow_id) count by ovpn_id, Datestamp, ovpn_ip_address
| rename ovpn_id AS "Client ID", ovpn_ip_address AS "True IP Address", values(ovpn_ip_port) AS Port
| fillnull value="No Data" "Client ID","True IP Address",Port
| sort -Datestamp</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">10</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">cell</option>
        <option name="percentagesRow">false</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">false</option>
        <format type="color" field="count">
          <colorPalette type="minMidMax" maxColor="#006D9C" minColor="#FFFFFF"></colorPalette>
          <scale type="minMidMax"></scale>
        </format>
        <format type="color" field="True IP Address">
          <colorPalette type="sharedList"></colorPalette>
          <scale type="sharedCategory"></scale>
        </format>
        <format type="color" field="Client ID">
          <colorPalette type="sharedList"></colorPalette>
          <scale type="sharedCategory"></scale>
        </format>
        <drilldown>
          <set token="drilldown">$click.value2$</set>
        </drilldown>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <html>
        <h1>
          <b>
            <font color="Orange">Flow ID = $drilldown$</font>
          </b>
        </h1>
      </html>
      <table>
        <search>
          <query>host=core flow_id=$drilldown$
| rex "\s"ovpn-client-"(?&lt;ovpn_id&gt;[A-Z]{1,6})"
| stats values(sourcetype) AS Sourcetype values(src_ip) as "Source IP" values(dest_ip) AS "Destination IP" by ovpn_id</query>
          <earliest>$earliest$</earliest>
          <latest>$latest$</latest>
        </search>
        <option name="count">10</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <format type="color" field="ovpn_id">
          <colorPalette type="sharedList"></colorPalette>
          <scale type="sharedCategory"></scale>
        </format>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <event>
        <search>
          <query>host=core flow_id=$drilldown$</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
        </search>
        <option name="count">3</option>
        <option name="list.drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </event>
    </panel>
  </row>
  <row>
    <panel>
      <title>Websites Visited (DNS)</title>
      <chart>
        <search>
          <query>host="core" (sourcetype="bro:dns:json")
    [| inputlookup clientID_privateIP.csv
| search "Client ID"=$client_id$
| table id.orig_h]
| rename query AS "Websites Visited"
| top limit=30 "Websites Visited"</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
        </search>
        <option name="charting.chart">pie</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.chart.showPercent">true</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
    <panel>
      <title>Websites Visited (HTTP &amp; SSL)</title>
      <chart>
        <search>
          <query>host="core" (sourcetype="*http*" OR sourcetype="*ssl*")
    [| inputlookup clientID_privateIP.csv
    | search "Client ID"=$client_id$
    | table id.orig_h]
| rename id.resp_h AS "Websites Visited"
| top limit=30 "Websites Visited"</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
        </search>
        <option name="charting.chart">pie</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.chart.showPercent">true</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
    <panel>
      <title>Web Traffic (HTTP &amp; SSL)</title>
      <table>
        <search>
          <query>host=core (sourcetype="*http*" OR sourcetype="*ssl*")
    [| inputlookup clientID_privateIP.csv
    | search "Client ID"=HDLSDX
    | table id.orig_h]
| rename id.orig_h AS "Client ID" id.resp_h AS "Websites Visited" id.resp_p AS Port
| table _time,"Client ID", "Websites Visited", Port</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <input type="text" token="mb_filter_files" searchWhenChanged="true">
        <label>Megabyte Filter (Files):</label>
        <default>500</default>
        <initialValue>500</initialValue>
      </input>
      <table>
        <title>File Transfer Activity (bro_files)</title>
        <search id="file_transfer_base">
          <query>host=core sourcetype="bro:files:json"
    [| inputlookup clientID_privateIP.csv
    | search "Client ID"=$client_id$
    | rename id.orig_h as rx_hosts
    | table rx_hosts]
| eval MB=((seen_bytes/1024)/1024)
| stats sum(MB) as "Total Bytes (MB)" by rx_hosts, tx_hosts, md5
| search "Total Bytes (MB)"&gt;$mb_filter_files$
| sort -"Total Bytes (MB)"</query>
          <earliest>0</earliest>
          <latest></latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">20</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="percentagesRow">false</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
        <format type="number" field="Total Bytes">
          <option name="unit">MB</option>
        </format>
        <format type="color" field="Total Bytes">
          <colorPalette type="list">[#53A051,#DC4E41]</colorPalette>
          <scale type="threshold">499</scale>
        </format>
        <format type="color" field="Total Bytes (MB)">
          <colorPalette type="list">[#53A051,#DC4E41]</colorPalette>
          <scale type="threshold">499</scale>
        </format>
        <format type="color" field="rx_hosts">
          <colorPalette type="sharedList"></colorPalette>
          <scale type="sharedCategory"></scale>
        </format>
      </table>
    </panel>
    <panel>
      <input type="text" token="mb_filter_http" searchWhenChanged="true">
        <label>Megabyte Filter (HTTP):</label>
        <default>500</default>
        <initialValue>500</initialValue>
      </input>
      <table>
        <title>HTTP alerts</title>
        <search id="http_alert_base">
          <query>host=core sourcetype="bro:http:json"
    [| inputlookup clientID_privateIP.csv
    | search "Client ID"=*
    | table id.orig_h]
| eval MB=((bytes/1024)/1024)
| stats sum(MB) as "Total Bytes (MB)" values(host) by src_ip, dest_ip
| search "Total Bytes (MB)"&gt;$mb_filter_http$
| sort -"Total Bytes (MB)"</query>
          <earliest>0</earliest>
          <latest></latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">20</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="percentagesRow">false</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">false</option>
        <format type="number" field="Total Bytes (MB)">
          <option name="unit">MB</option>
        </format>
        <format type="color" field="Total Bytes (MB)">
          <colorPalette type="list">[#53A051,#DC4E41]</colorPalette>
          <scale type="threshold">499</scale>
        </format>
        <format type="color" field="src_ip">
          <colorPalette type="sharedList"></colorPalette>
          <scale type="sharedCategory"></scale>
        </format>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <title>Alert Domains</title>
      <table>
        <search id="domain_alerts">
          <query>host="core" (sourcetype="bro:dns:json")
    [| inputlookup alert_domains.csv
    | rename "Domains to Alert on" AS query
    | table query]
| lookup clientID_privateIP.csv id.orig_h AS src_ip OUTPUT "Client ID" AS client_id
| search client_id=$client_id$
| bucket _time span=1h
| convert ctime(_time) as Datestamp
| stats values(Datestamp) AS Time_Range values(client_id) AS Client_IDs, values(src_ip) AS "Source IPs", values(dest_ip) AS "Dest IPs", by query</query>
          <earliest>0</earliest>
          <latest></latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">10</option>
        <option name="drilldown">none</option>
        <format type="color" field="query">
          <colorPalette type="sharedList"></colorPalette>
          <scale type="sharedCategory"></scale>
        </format>
        <format type="color" field="Client_IDs">
          <colorPalette type="sharedList"></colorPalette>
          <scale type="sharedCategory"></scale>
        </format>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <title>IP-based Alerting</title>
      <table>
        <search id="ip_alerts">
          <query>host="core" (sourcetype="*http*" OR sourcetype="*ssl*")
    [| inputlookup alert_ips.csv
    | rename "IP to Alert on" AS id.resp_h
    | table id.resp_h]
| lookup clientID_privateIP.csv id.orig_h AS src_ip OUTPUT "Client ID" AS client_id
| search client_id=$client_id$
| bucket _time span=1h
| convert ctime(_time) as Datestamp
| stats values(Datestamp) AS Time_Range values(client_id) as "Client_ID" values(uri) AS "URIs" values(user_agent) AS "User Agents" by id.resp_h</query>
          <earliest>0</earliest>
          <latest></latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">20</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="percentagesRow">false</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
        <format type="color" field="Client_ID">
          <colorPalette type="sharedList"></colorPalette>
          <scale type="sharedCategory"></scale>
        </format>
        <format type="color" field="id.resp_h">
          <colorPalette type="sharedList"></colorPalette>
          <scale type="sharedCategory"></scale>
        </format>
      </table>
    </panel>
  </row>
</form>
